{% extends "main.html" %}
{% block content %}
<div id="tables" class="table-view-container"></div>


<div id="schemata" class="schemata-view">
    <input type="text" name="search" class="schemata-search" />
    <div class="schemata-list">
    </div>
</div>

<div id="query-columns-container"></div>

<script type="text/javascript">
function Schema(name){
    this.name = name
    this.tables = []
}

function Table(name, schema){
    this.schema = schema;
    this.name = name;
    this.columns = [];
}

Table.prototype.fullName = function(){
    return this.schema.name + "." + this.name;
}

function Column(name, is_pk, table){
    this.name = name;
    this.table = table;
    this.is_pk = is_pk;
}

function parseSchemata(schemata){
    var schemas = [];
    for(var schema_name in schemata){
        var schema = new Schema(schema_name);
        var tables = schemata[schema_name];
        for(var table_name in tables){
            var table = new Table(table_name, schema);
            var cols = tables[table_name];
            for(var i = 0; i < cols.length; i++){
                var col = cols[i];
                table.columns.push(new Column(col.name, col.pk, table));
            }
            schema.tables.push(table);
        }
        schemas.push(schema);
    }
    return schemas;
}

SCHEMATA = {{ schemata|safe }};
SCHEMATA = parseSchemata(SCHEMATA);

/*
 * Allows objects to register callbacks for events, and lets objects broadcast
 * events to all registered listeners.
 * Public methods:
 *     listenFor(string event_type_name, function callback)
 *     broadcast(obj this_argument for callback function, string event_type_name, obj argument to pass to callback)
 */
var EventRegistry = {
    listeners: {},
    listenFor: function(type, callback){
        var types = type.split(" ");
        for(var i = 0; i < types.length; i++){
            var type = types[i]; 
            if(!(type in this.listeners)){
                this.listeners[type] = [];
            }
            this.listeners[type].push(callback);
        }
    },
    broadcast: function(this_arg, type, event_arg){
        var listeners = this.listeners[type];
        for(var i = 0; i < listeners.length; i++){
            listeners[i].call(this_arg, event_arg);
        }
    }
}

/* 
 * Generates a unique key for any view object, and allows the view to be
 * retrieved using that key.
 * Public methods: 
 *     register(View object)
 *     getViewByKey(string key)
 */
var ViewRegistry = {
    key: 0,
    registry: {},
    register: function(view){
        this.key++;
        this.registry[this.key] = view;
        return this.key;
    },
    getViewByKey: function(key){
        return this.registry[key];
    }
}

function RelationshipOptionsView(relationship){
    this.relationship = relationship;
}

RelationshipOptionsView.prototype.render = function(){

}

function QueryColumnsView(container){
    this.element = null;
    this.container = container;
}

QueryColumnsView.prototype.render = function(){
    var html = [];
    html.push('<div class="query-columns-view">');
        html.push('<table>');
            html.push('<tr class="field-row"><th>Field:</th></tr>');
            html.push('<tr class="sort-row"><th>Sort:</th></tr>');
            html.push('<tr class="show-row"><th>Show:</th></tr>');
            html.push('<tr class="criteria-row"><th>Criteria:</th></tr>');
            html.push('<tr class="or-row"><th>or:</th></tr>');
            html.push('<tr class="or-row"><th>&nbsp;</th></tr>');
            html.push('<tr class="or-row"><th>&nbsp;</th></tr>');
            html.push('<tr class="or-row"><th>&nbsp;</th></tr>');
            html.push('<tr class="or-row"><th>&nbsp;</th></tr>');
        html.push('</table>');
    html.push("</div>");
    this.element = $(html.join(""));
    this.container.append(this.element);
}

QueryColumnsView.prototype.appendColumn = function(column_view){
    var name = column_view.column.table.fullName() + "." + column_view.column.name;
    this.element.find(".field-row").append($("<td><input type='text' value='" + name + "'></td>"));
    this.element.find(".sort-row").append($("<td><select name=''><option value='none'>None</option></select></td>"));
    this.element.find(".show-row").append($("<td><input type='checkbox' /></td>"));
    this.element.find(".criteria-row").append($("<td><input type='text' /></td>"));
    this.element.find(".or-row").append($("<td><input type='text' /></td>"));
}

/*
 * Adds, removes and draws the relationships between ColumnViews. 
 * Public methods:
 *     addRelationship(ColumnView a, ColumnView b)
 *     removeRelationship(ColumnView)
 *     draw()
 */
function RelationshipView(container){
    this.relationships = [];
    this.inactive_stroke_width = 5;
    this.active_stroke_width = 10;
    this.watching_for_keypress = false; 
    this.container = container;
    this.element = null;
}

RelationshipView.prototype.render = function(){
    //var html = '<svg xmlns="http://www.w3.org/2000/svg" version="1.1" style="background:none; width:100%; height:100%; position:relative; top:0; left:0; z-index:-1;"> </svg>'
    //this.element = $(html);
    //this.container.append(this.element);
}

RelationshipView.prototype.addRelationship = function(a, b){
    this.relationships.push({
        a: a,
        b: b
    });
    this.draw();
}

RelationshipView.prototype.removeRelationshipByIndex = function(index){
    this.relationships.splice(index, 1);
    this.draw();
}

RelationshipView.prototype.removeRelationshipsRelatedToColumnView = function(column_view){
    for(var i = this.relationships.length - 1; i >= 0; i--){
        if(this.relationships[i].a == column_view || this.relationships[i].b == column_view){
            this.relationships.splice(i, 1);
        }
    }
    this.draw();
}

RelationshipView.prototype.draw = function(){
    $('body svg').remove();
    for(var i = 0; i < this.relationships.length; i++){
        var relationship = this.relationships[i];
        this.drawConnection(relationship.a, relationship.b, i);
    }

    //this.bindEvents();
}

RelationshipView.prototype.drawConnection = function(a, b, index){
    var b_offset = b.element.find(".column-dragger").offset();
    var a_offset = a.element.find(".column-dragger").offset();
    var a_width = a.element.closest(".table-view").width();
    var b_width = b.element.closest(".table-view").width();

    var line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    
    var vertical_offset = 10;
    var horizontal_offset = 20;

    var line_out_of_a = "";
    var line_into_b = "";
    if(a_offset.left + (a_width/2) < b_offset.left + (b_width/2)){
        // the line should start at the right side of `a`, and go to the left of `b`
        var start_x = a_offset.left+a_width;
        var start_y = a_offset.top + vertical_offset;

        var end_x = b_offset.left;
        var end_y = b_offset.top + vertical_offset

        //line_out_of_a += "M" + (a_offset.left+a_width) + " " + (a_offset.top + vertical_offset);
        //line_out_of_a += " l " + horizontal_offset + " 0 ";

        //line_into_b += " L " + (b_offset.left - horizontal_offset) + " " + (b_offset.top + vertical_offset);
        //line_into_b += " l " + horizontal_offset + " 0 ";
    } else {
        // the line should start at the left side of `a`, and go to the right of `b`
        var start_x = a_offset.left;
        var start_y = a_offset.top + vertical_offset;

        var end_x = b_offset.left + b_width;
        var end_y = b_offset.top + vertical_offset;

        //line_out_of_a += "M" + a_offset.left + " " + (a_offset.top + vertical_offset);
        //line_out_of_a += " l " + (-horizontal_offset) + " 0 ";

        //line_into_b += " L " + (b_offset.left + b_width+horizontal_offset) + " " + (b_offset.top + vertical_offset);
        //line_into_b += " l " + (-horizontal_offset) + " 0 ";
    }
    //var path = line_out_of_a + " " + line_into_b;
    var top = Math.min(start_y, end_y);
    var left = Math.min(start_x, end_x);
    var width = Math.abs(start_x - end_x);
    var height = Math.abs(start_y - end_y);

    var canvas = $('<svg xmlns="http://www.w3.org/2000/svg" pointer-events="none" version="1.1" style="background:none; position:absolute; top:0; left:0; "> </svg>');
    var padding = 30;
    canvas.css({
        top: top-padding,
        left: left-padding,
        width: width + padding*2,
        height: height + padding*2
    });

    var z_shape = (a_offset.left + a_width/2 < b_offset.left + b_width/2) && (a_offset.top < b_offset.top)
                  ||
                 (b_offset.left + b_width/2 < a_offset.left + a_width/2) && (b_offset.top < a_offset.top)

    if(z_shape){
        var path = "M " + padding + " " + padding + " l " + horizontal_offset + " 0 l " + (width-horizontal_offset*2) + " " + (height) + " l " + horizontal_offset + " 0 ";
        console.log("zshape");
    } else {
        var path = "M " + padding + " " + (padding+height) + " l " + horizontal_offset + " 0 l " + (width-horizontal_offset*2) + " " + (-height) + " l " + horizontal_offset + " 0 ";
        //var path = "M 0 " + height + " L " + width + " 0 ";
        console.log("sshape");
    }

    line.setAttribute("d", path);
    line.setAttribute("stroke-width", this.inactive_stroke_width);
    line.setAttribute("stroke", 'black');
    line.setAttribute("fill", 'none');
    line.setAttribute("class", "relationship");
    line.setAttribute("data-index", index);
    line.setAttribute("pointer-events", "stroke");
    canvas.get()[0].appendChild(line);

    $('body').append(canvas);
}

RelationshipView.prototype.setActiveRelationship = function(line_element){
    // reset the stroke width on all other lines
    this.element.find(".relationship").attr("stroke-width", this.inactive_stroke_width)
    // reset the `data-active` attribute on ll the lines
    this.element.find(".relationship").attr("data-active", "0");

    if(line_element){
        // set the stroke width, and data-active attribute on the active line
        $(line_element).attr('stroke-width', this.active_stroke_width);
        $(line_element).attr('data-active', "1");
    }
}

RelationshipView.prototype.bindEvents = function(){
    var that = this;
    // this prevents text from being highlighted on the dblclick 
    // (http://stackoverflow.com/questions/880512/prevent-text-selection-after-double-click)
    this.element.find(".relationship").on('mousedown', function(e){ e.preventDefault() });

    // bind to the body element (making sure we only do it once), and watch for
    // DEL key presses. When the DEL key is pressed, and we have an active
    // relationship (i.e. the user clicked on a line), we delete the relationship
    if(!this.watching_for_keypress){
        $('body').bind("keydown", function(e){
            if(e.keyCode != 46) return; // only watch for the DEL key
            // delete the active relationship (if there is one)
            // find the active element
            var active_element = this.element.find(".relationship[data-active='1']");
            if(active_element.length == 1){
                var index = active_element.attr("data-index");
                that.removeRelationshipByIndex(index);
            }
        });

        // when something is clicked, reset the activate relationship
        $('body').bind("click", function(e){
            that.setActiveRelationship(null);
        });

        this.watching_for_keypress = true;
    }

    // when a relationship is clicked set it as the active one
    this.element.find(" .relationship").on('click', function(e){ 
        that.setActiveRelationship(this);
        // prevent the body.click event from firing (since that will deactivate
        // the active line)
        e.stopPropagation();
    });

    // when the relationship is dblclicked, inform the event registry 
    this.element.find(".relationship").on('dblclick', function(e){
        var index = parseInt($(this).data("index"), 10);
        var relationship = that.relationships[index];
        EventRegistry.broadcast(that, "dblclick", {
            relationship: relationship
        });
    });
}

function ColumnView(column, container){
    this.column = column;
    this.container = container;
    this.element = null;
    this.key = ViewRegistry.register(this);
}

ColumnView.prototype.render = function(){
    var cls = ""
    if(this.column.is_pk) cls = 'primary-key';
    this.element = $('<tr class="column-view"><td><i class="icon-resize-horizontal column-dragger" data-key="' + this.key + '"></i></td><td class="name">' + this.column.name + '</td></tr>');
    this.container.append(this.element);
    this.bindEvents(); 

    $('.column-dragger').draggable({
        appendTo: 'body',
        helper: 'clone',
        zIndex: 3
    });

    $('.column-dragger').droppable({
        drop: function(event, ui){
            var from = $(event.srcElement);
            var to = $(this);

            var from_key = from.data("key");
            var to_key = to.data("key");

            var from_view = ViewRegistry.getViewByKey(from_key);
            var to_view = ViewRegistry.getViewByKey(to_key);

            EventRegistry.broadcast(this, "relationship_formed", {
                a: to_view,
                b: from_view
            })
        }
    });
}

ColumnView.prototype.bindEvents = function(){
    var that = this;
    this.element.find('.name').on('dblclick', function(e){
        EventRegistry.broadcast(that, 'dblclick', {

        });
    });
}

function TableView(table, container){
    this.table = table;
    this.container = container;
    this.element = null;
    this.column_views = [];
    this.key = ViewRegistry.register(this);
}

TableView.prototype.render = function(){
    var html = ['<div class="table-view">'];
    html.push('<div class="header"><span class="remove"><i class="icon-remove"></i></span> ' + this.table.fullName() + '</div>')
    html.push('<input type="text" name="table-name" value="' + this.table.name + '" />');
    html.push('<table class="columns"><tbody>');
    html.push('</tbody></table>');
    html.push('</div>');
    this.element = $(html.join(""));
    this.container.append(this.element);

    var column_div = this.element.find(".columns");
    this.column_views = [];
    for(var i = 0; i < this.table.columns.length; i++){
        var cv = new ColumnView(this.table.columns[i], column_div)
        cv.render();
        this.column_views.push(cv);
    }

    var that = this;
    // make myself draggable
    $(this.element).draggable({
        'handle': '.header',
        'drag': function(){ EventRegistry.broadcast(that, "drag", null) },
        'stop': function() { EventRegistry.broadcast(that, "stop", null) }
    });

    this.bindEvents();
}

TableView.prototype.remove = function(){
    EventRegistry.broadcast(this, "closed", null);
    this.element.remove();
}

TableView.prototype.bindEvents = function(){
    var that = this;
    $(this.element).find('.icon-remove').on('click', function(){
        that.remove();
    });
}

function SchemataView(schemas, container){
    this.container = container;
    this.schemas = schemas;
}

SchemataView.prototype.render = function(){
    var html = ['<ul>'];
    for(var i = 0; i < this.schemas.length; i++){
        var schema = this.schemas[i];
        html.push("<li class='schema-info'><span class='schema-name'><i class='icon-folder-close'></i> " + schema.name + "</span><ul class='table-list'>");
        var tables = schema.tables;
        for(var j = 0; j < tables.length; j++){
            html.push("<li><i class='icon-list-alt'></i> <span class='table-name'>" + tables[j].name + "</span></li>")
        }
        html.push("</ul></li>");
    }

    this.container.find('.schemata-list').html(html.join(""))
    this.collapseAllTableLists();
    this.bindEvents();
}

SchemataView.prototype.collapseAllTableLists = function(){
    this.container.find(".table-list").hide();
}

SchemataView.prototype.tableObjectFromDOM = function(element){
    var table_name = $.trim($(element).text());
    var schema_name = $.trim($(element).closest('.schema-info').find('.schema-name').text());
    console.log(table_name, schema_name);
    var table = this.findTableObject(schema_name, table_name);
    return table;
}

SchemataView.prototype.findTableObject = function(schema_name, table_name){
    // find the schema object
    for(var i = 0; i < this.schemas.length; i++){
        var schema = this.schemas[i];
        if(schema.name == schema_name) break;
    }

    // now find the table object
    for(var i = 0; i < schema.tables.length; i++){
        var table = schema.tables[i];
        if(table.name == table_name) return table;
    }

    return null;
}

SchemataView.prototype.bindEvents = function(){
    // when the schema name is clicked, slide up or down the list of tables,
    // and change the folder icon to either open or closed
    this.container.find(".schema-name").on('click', function(){
        var table_list = $(this).closest("li").find('.table-list');
        var icon = $(this).find("i");
        if(table_list.is(":visible")){
            table_list.slideUp();
            icon.removeClass("icon-folder-open").addClass("icon-folder-close");
        } else {
            table_list.slideDown();
            icon.addClass("icon-folder-open").removeClass("icon-folder-close");
        }
    });

    // notify the event listeners
    var that = this;
    this.container.on('dblclick', '.table-name', function(){
        var table = that.tableObjectFromDOM($(this));
        var event = {
            table: table,
        }
        EventRegistry.broadcast(that, "dblclick", event);
    });
}

$(document).ready(function(){
    var schemata_view = new SchemataView(SCHEMATA, $('#schemata'));
    schemata_view.render();

    // when a table name is clicked in the SchemataView, add it to the page
    EventRegistry.listenFor("dblclick", function(event){
        if(!(this instanceof SchemataView)) return;
        var tv = new TableView(event.table, $('#tables'));
        tv.render();
    });

    var relationship_view = new RelationshipView($('#tables'));
    relationship_view.render();
    // when a relationship is formed, add it to the view
    EventRegistry.listenFor("relationship_formed", function(event){
        relationship_view.addRelationship(event.a, event.b);
    });
    // when a tableview is dragged we need to redraw all the connections in the
    // relationship view (since the lines need to originate from the tableview)
    EventRegistry.listenFor("drag stop", function(event){
        if(!(this instanceof TableView)) return;
        relationship_view.draw();
    });
    // when a table is closed, we need to delete all the relationships based on
    // it
    EventRegistry.listenFor("closed", function(event){
        if(!(this instanceof TableView)) return;
        // remove all relationships based on columns in this tableview
        for(var i = 0; i < this.column_views.length; i++){
            relationship_view.removeRelationshipsRelatedToColumnView(this.column_views[i]);
        }
    });
    // when a relationship is dblclicked we want to display a modal options dialog window
    EventRegistry.listenFor("dblclick", function(event){
        if(!(this instanceof RelationshipView)) return;
        console.log(event.relationship);
    });

    var query_columns_view = new QueryColumnsView($('#query-columns-container'));
    query_columns_view.render();
    EventRegistry.listenFor("dblclick", function(event){
        if(!(this instanceof ColumnView)) return;
        query_columns_view.appendColumn(this);
    });
});

</script>

{% comment %}
<h3>Step 1</h3>
<p>Choose the tables/views you want to join:</p>

{% if form.errors %}
    <div class="alert alert-error">
        <strong>Some errors were detected!</strong> You must fix them before you can continue.
    </div>
{% endif %}

<form method="post" action="" class="strong-labels">
    {% csrf_token %}
    {{ form.non_field_errors }}
    {% for schema_name, fields in form.schemas.items %}
        <label>{{ schema_name }}</label>
        <div class="light-labels">
            {% for field in fields %}
                <label class="checkbox">{{ field }} {{ field.label }}</label>
            {% endfor %}
        </div>
    {% endfor %}

    <input type="submit" name="Submit" value="Continue" />
</form>
{% endcomment %}

{% endblock %}
