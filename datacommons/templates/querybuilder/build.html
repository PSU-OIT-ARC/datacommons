{% extends "main.html" %}
{% block content %}

<div id="tables" class="table-view-container"></div>

<div id="schemata" class="schemata-view">
    <div class="schemata-list">
    </div>
</div>

<div id="query-columns-container">
<div>
    <a href="#" class="btn btn-small" id="toggle-totals">Totals</a>
    <a href="#" class="btn btn-small" id="view-sql">View SQL</a>
    <a href="#" class="btn btn-small">Run</a>
</div>
</div>

<script type="text/javascript" src="{{ STATIC_URL }}js/querybuilder.js"></script>
<script type="text/javascript">
SCHEMATA = {{ schemata|safe }};
SCHEMATA = parseSchemata(SCHEMATA);
$(document).ready(function(){
    var schemata_view = new SchemataView(SCHEMATA, $('#schemata'));
    schemata_view.render();
    
    var stack_height = 0;

    // when a table name is clicked in the SchemataView, add it to the page
    EventRegistry.listenFor("click", function(event){
        if(!(this instanceof SchemataView)) return;
        var tv = new TableView(event.table, $('#tables'));
        tv.render();
        var offset = tv.element.offset()
        // do a window cascade based on the stack_height
        tv.element.css({
            left: offset.left + 10*stack_height,
            top: offset.top + 10*stack_height
        })
        tv.moved = false;
        stack_height++;
    });

    var relationship_view = new RelationshipView($('#tables'));
    relationship_view.render();
    // when a relationship is formed, add it to the view
    EventRegistry.listenFor("relationship_formed", function(event){
        relationship_view.addRelationship(event.a, event.b);
    });
    // when a tableview is dragged we need to redraw all the connections in the
    // relationship view (since the lines need to originate from the tableview)
    EventRegistry.listenFor("drag stop", function(event){
        if(!(this instanceof TableView)) return;
        relationship_view.redrawRelationshipsRelatedTo(this);
        if(!this.moved) stack_height--;
        this.moved = true;
    });
    // when a table is closed, we need to delete all the relationships based on
    // it
    EventRegistry.listenFor("closed", function(event){
        if(!(this instanceof TableView)) return;
        // remove all relationships based on columns in this tableview
        for(var i = 0; i < this.column_views.length; i++){
            relationship_view.removeRelationshipsRelatedToColumnView(this.column_views[i]);
        }
        if(!this.moved) stack_height--;
    });
    // when a relationship is dblclicked we want to display a modal options dialog window
    EventRegistry.listenFor("dblclick", function(event){
        if(!(this instanceof RelationshipView)) return;
        console.log(event.relationship);
    });

    var query_columns_view = new QueryColumnsView($('#query-columns-container'));
    query_columns_view.render();
    EventRegistry.listenFor("click", function(event){
        if(!(this instanceof ColumnView)) return;
        query_columns_view.appendColumn(this);
    });

    $('#toggle-totals').click(function(e){
        e.preventDefault();
        query_columns_view.toggleTotals();
        $(this).toggleClass("active");
    });
    $('#view-sql').click(function(e){
        e.preventDefault();
        var sql = {}
        sql = query_columns_view.toSQL(sql);
        sql = relationship_view.toSQL(sql);
        var sql_string = "SELECT " + sql.select.join(", ");
        sql_string += " FROM " + sql.from
        if(sql.where.length){
            sql_string += " WHERE " + sql.where.join(" AND ");
        }
        if(sql.group_by.length){
            sql_string += " GROUP BY " + sql.group_by.join(", ");
        }
        if(sql.order_by.length){
            sql_string += " ORDER BY " + sql.order_by.join(", ");
        }
        console.log(sql_string);
    });
});

</script>

{% endblock %}
