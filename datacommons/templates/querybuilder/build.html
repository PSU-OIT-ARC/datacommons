{% extends "main.html" %}
{% block content %}

<div id="tables" class="table-view-container"></div>

<div id="schemata" class="schemata-view">
    <div class="schemata-list">
    </div>
</div>

<div id="query-columns-container">
<div>
    <a href="#" class="btn btn-small" id="toggle-totals">Totals</a>
    <a href="#" class="btn btn-small" id="view-sql">View SQL</a>
    <a href="#" class="btn btn-small">Run</a>
</div>
</div>

<script type="text/javascript" src="{{ STATIC_URL }}js/querybuilder.js"></script>
<script type="text/javascript">
SCHEMATA = {{ schemata|safe }};
SCHEMATA = parseSchemata(SCHEMATA);
$(document).ready(function(){
    var schemata_view = new SchemataView(SCHEMATA, $('#schemata'));
    schemata_view.render();

    // when a table name is clicked in the SchemataView, add it to the page
    EventRegistry.listenFor("click", function(event){
        if(!(this instanceof SchemataView)) return;
        var tv = new TableView(event.table, $('#tables'));
        tv.render();
    });

    var relationship_view = new RelationshipView($('#tables'));
    relationship_view.render();
    // when a relationship is formed, add it to the view
    EventRegistry.listenFor("relationship_formed", function(event){
        relationship_view.addRelationship(event.a, event.b);
    });
    // when a tableview is dragged we need to redraw all the connections in the
    // relationship view (since the lines need to originate from the tableview)
    EventRegistry.listenFor("drag stop", function(event){
        if(!(this instanceof TableView)) return;
        relationship_view.redrawRelationshipsRelatedTo(this);
    });
    // when a table is closed, we need to delete all the relationships based on
    // it
    EventRegistry.listenFor("closed", function(event){
        if(!(this instanceof TableView)) return;
        // remove all relationships based on columns in this tableview
        for(var i = 0; i < this.column_views.length; i++){
            relationship_view.removeRelationshipsRelatedToColumnView(this.column_views[i]);
        }
    });
    // when a relationship is dblclicked we want to display a modal options dialog window
    EventRegistry.listenFor("dblclick", function(event){
        if(!(this instanceof RelationshipView)) return;
        console.log(event.relationship);
    });

    var query_columns_view = new QueryColumnsView($('#query-columns-container'));
    query_columns_view.render();
    EventRegistry.listenFor("click", function(event){
        if(!(this instanceof ColumnView)) return;
        query_columns_view.appendColumn(this);
    });

    $('#toggle-totals').click(function(e){
        e.preventDefault();
        query_columns_view.toggleTotals();
        $(this).toggleClass("active");
    });
    $('#view-sql').click(function(e){
        e.preventDefault();
        relationship_view.toSQL();
    });
});

</script>

{% comment %}
<h3>Step 1</h3>
<p>Choose the tables/views you want to join:</p>

{% if form.errors %}
    <div class="alert alert-error">
        <strong>Some errors were detected!</strong> You must fix them before you can continue.
    </div>
{% endif %}

<form method="post" action="" class="strong-labels">
    {% csrf_token %}
    {{ form.non_field_errors }}
    {% for schema_name, fields in form.schemas.items %}
        <label>{{ schema_name }}</label>
        <div class="light-labels">
            {% for field in fields %}
                <label class="checkbox">{{ field }} {{ field.label }}</label>
            {% endfor %}
        </div>
    {% endfor %}

    <input type="submit" name="Submit" value="Continue" />
</form>
{% endcomment %}

{% endblock %}
